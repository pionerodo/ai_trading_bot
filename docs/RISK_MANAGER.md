# **AI Trading Bot — RISK_MANAGER.md (v2.0)**

### **Status:** Finalized — aligned with PROJECT_OVERVIEW, DECISION_ENGINE v2.0, EXECUTION_ENGINE v2.0**

---

# **1. Purpose**

Risk Manager — это центральный модуль контроля риска. Он определяет **можно ли торговать**, **каким объёмом**, **при каких условиях**, и может полностью отменить торговое решение.

Risk Manager действует на всех этапах:

* перед формированием решения (Decision Engine),
* перед открытием позиции (Execution Engine),
* во время сопровождения открытой позиции,
* при любых рыночных аномалиях.

Risk Manager определяет:

* глобальный режим риска (`risk_mode`),
* допустимость сделки,
* ограничения по количеству сделок,
* контроль дневного/недельного Drawdown,
* минимальные требования к SL/RR,
* размер позиции и максимально допустимое плечо.

---

# **2. Global Risk Modes**

Risk Manager работает в трёх глобальных режимах, влияющих на все решения:

## **2.1 risk_off (торговля запрещена)**

Активируется, если:

* дневной DD ≥ дневного лимита,
* недельный DD ≥ недельного лимита,
* критический ETF outflow,
* критические ликвидационные кластеры против позиции,
* экстремальная волатильность (ATR spike),
* биржевые ограничения или ошибки API.

**Результат:**

* Decision Engine может выдавать только `flat`,
* Execution Engine закрывает существующую позицию при первой возможности.

---

## **2.2 cautious (умеренный режим)**

Активируется, если:

* существуют сильные предупреждения в потоках,
* толпа ведёт себя экстремально (crowd extreme),
* рынок в фазе высокой неопределённости,
* слишком сильные ликвидационные зоны рядом с входом.

**Ограничения:**

* уменьшается размер позиции (коэффициент 0.5),
* плечо ограничивается до conservative_max_leverage,
* confidence сигналов понижается.

---

## **2.3 aggressive (разрешён только при сильных сигналах)**

Активируется, если:

* рынок структурно стабильный,
* позитивный поток (ETF inflow, страх толпы, ликвидации в нужной стороне),
* повышенная вероятность качественного тренда.

**Особенности:**

* риск-параметры стандартные,
* size может быть увеличен до risk_percent_high,
* используется только при полной чистоте сигналов.

---

# **3. Hard Risk Limits (обязательные правила)**

Эти правила никогда не нарушаются ни Decision Engine, ни Execution Engine.

## **3.1 Минимальный SL — 0.35%**

Любая сделка должна иметь SL **не ближе** чем 0.35% от фактического входа.

Если SL по структуре меньше:

* SL увеличивается Engine-ом,
* логируется предупреждение,
* RR пересчитывается.

## **3.2 Минимальный RR — 2.0**

RR1 = TP1 / SL ≥ 2.0.

Если RR < 2 — сделка запрещена.

## **3.3 Ограничение по max trades per day**

Если количество сделок ≥ лимита (например, 5):

* все новые `action = flat`, пока не начнётся новый день.

## **3.4 Дневной Drawdown (Daily DD)**

Если дневной DD превышает порог (например, 3–5%):

* risk_mode = risk_off,
* новые сделки запрещены,
* Execution Engine поддерживает только защитные действия.

## **3.5 Недельный Drawdown (Weekly DD)**

Если недельный DD превышает лимит:

* risk_mode = risk_off,
* торговля полностью блокируется до нового периода.

## **3.6 Учитывание ликвидационных зон**

Если вход расположен:

* слишком близко к мощному кластеру пр ضد позиции,
* или TP1 попадает в зону RR < 2,
  то сделка запрещена.

## **3.7 Ограничение плеча (leverage limits)**

Леверидж зависит от risk_mode:

* risk_off → плечо не используется,
* cautious → ≤ conservative_max_leverage,
* normal/aggressive → ≤ max_leverage.

---

# **4. Position Size Calculation**

Размер позиции строится по риск-модели.

Формула:

```text
risk_usdt = equity * risk_percent
sl_distance = abs(entry - sl)
position_size = risk_usdt / sl_distance
```

Далее:

* применяется ограничение биржи по min/max notional,
* применяется ограничение по leverage,
* проводится округление по шагу актива.

## **4.1 Коррекция в cautious режиме**

```text
position_size *= 0.5
```

## **4.2 Коррекция при ETF-шоке**

Если ETF outflow большой:

* position_size *= 0.3…0.7

---

# **5. Risk Checks (используется в Decision Engine)**

Decision Engine вызывает Risk Manager перед тем, как принять решение.

Risk Manager возвращает набор булевых флагов:

```json
{
  "daily_dd_ok": true,
  "weekly_dd_ok": true,
  "max_trades_per_day_ok": true,
  "session_ok": true,
  "no_major_news": true,
  "liquidation_ok": true,
  "etf_ok": true
}
```

Если любой флаг из критических = false:

* `action = flat`
* сделка запрещена независимо от сигналов.

Критические:

* daily_dd_ok
* weekly_dd_ok
* max_trades_per_day_ok
* liquidation_ok

---

# **6. Real-Time Execution Constraints (локальный контроль в Execution Engine)**

Execution Engine должен выполнять локальные проверки риска:

## **6.1 SL protection**

Если при открытой позиции:

* SL отсутствует → ставится немедленно,
* SL слишком близко → корректируется вверх до 0.35%.

## **6.2 Volatility / spread filters**

Если:

* spread слишком велик,
* волатильность экстремальная,
  то new-entry запрещён.

## **6.3 Forced Exit**

Если Risk Manager переключает `risk_mode = risk_off` **после** открытия позиции:

* Execution Engine должен закрыть позицию при ближайшей безопасной возможности.

---

# **7. Liquidation-Aware Risk Management**

## **7.1 Входы**

Запрещено входить:

* прямо в сильный ликвидационный кластер,
* если ближайший ликвидационный кластер по направлению TP делает RR < 2.

## **7.2 Выходы**

Если цена входит в зону ликвидаций:

* активируется агрессивный трейлинг,
* может быть выполнен частичный выход (25–50%),
* может быть выполнен полный выход при подтверждении риска.

---

# **8. Confidence Adjustment Rules**

Risk Manager регулирует уверенность (`confidence`) Decision Engine:

## **8.1 Понижение confidence**

* сильные ETF outflows → -0.15 до -0.35
* crowd extreme → -0.1…-0.2
* сильные ликвидационные зоны сверху (для лонга) → -0.1

## **8.2 Повышение confidence**

* совпадение сигналов structure + momentum + derivatives
* ETF inflow → +0.1… +0.2

---

# **9. Consolidated Risk Override Logic**

Финальный контроль перед открытием позиции:

```python
if not daily_dd_ok: return block
if not weekly_dd_ok: return block
if not max_trades_ok: return block
if not liquidation_ok: return block
if rr < 2.0: return block
if sl_distance < 0.0035: return block
return allow
```

---

# **10. Logging Requirements**

Risk Manager обязан логировать:

* изменения режима риска (risk_mode),
* блокировки сделок,
* причины корректировок размера позиции,
* предупреждения ETF/liq/crowd,
* дневной и недельный DD.

Все события попадают:

* в текстовый лог (`logs/risk_manager.log`),
* в структурированную таблицу `logs` в DB.

---

# **11. Summary**

Risk Manager v2.0 обеспечивает:

* единый центр контроля риска,
* строгие правила SL ≥ 0.35% и RR ≥ 2,
* фильтрацию сделок по ликвидационным зонам,
* контроль дневного/недельного DD,
* динамическую регулировку позиции,
* взаимодействие с Execution Engine по безопасному сопровождению.

Вместе с `DECISION_ENGINE.md` и `EXECUTION_ENGINE.md` формирует полный контур управления риском и исполнением для AI Trading Bot.
