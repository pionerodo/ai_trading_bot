# Мониторинг и реакции на инциденты

Ниже перечислены минимальные метрики/алерты и базовые действия при срабатывании.

## Метрики и пороги
- `decision_db_insert_failures{symbol,action}` — счётчик неудачных вставок решений. **Порог:** ≥3 ошибки за 5 минут или 2 подряд.
- `candles_fetch_failures{symbol,timeframe}` — ошибки запросов к Binance. **Порог:** ≥3 подряд для одного таймфрейма.
- `candles_select_failures{symbol,timeframe}` — неудачные SELECT при поиске последней свечи. **Порог:** ≥1 (сразу, блокирует загрузку).
- `candles_insert_failures{symbol,timeframe}` — ошибки вставки свечей. **Порог:** ≥1 (сразу, риск потерять данные).
- `candles_db_connection_failures` — неудачные подключения к БД при старте коллектора. **Порог:** ≥1 (сразу).

## Действия при инцидентах
- **decision_db_insert_failures**: проверить доступность БД и состояние миграций; при множественных ошибках включить уровень логирования DEBUG и зафиксировать JSON-запрос из structured logging; временно остановить приём новых решений, если ошибки продолжаются.
- **candles_fetch_failures**: сверить доступность Binance API и сетевые ограничения; переключить запросы на резервную точку/прокси; при частичных сбоях уменьшить `BINANCE_MAX_LIMIT` и перезапустить сборщик.
- **candles_select_failures**: проверить целостность таблицы `candles`, права подключения и латентность; до устранения проблемы приостановить заливку новых батчей, чтобы избежать дублирования.
- **candles_insert_failures**: выполнить `ROLLBACK` (скрипт делает это автоматически) и убедиться в корректности схемы таблицы; при повторных ошибках — включить подробное логирование и изолировать проблемный таймфрейм/символ.
- **candles_db_connection_failures**: проверить параметры подключения (`config/config*.yaml`), статус MariaDB и лимиты соединений; после восстановления соединения перезапустить `candles_collector.py`.

## Наблюдаемость
- Structured logging генерирует JSON-события с полями `event`, `symbol`, `timeframe` и деталями ошибки — используйте их для кореляции с метриками.
- `get_metrics_snapshot()` вызывается по завершении `candles_collector.py` и может быть отправлен во внешний алертинг/дашборд.
