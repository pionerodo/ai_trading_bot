# AI Trading Showdown Bot – Data Pipeline & JSON Schemas

Version: 1.0  
Status: Aligned with core Technical Specification

---

## 1. Purpose

This document describes the **data pipeline** of the AI Trading Showdown Bot:

- how data flows between components,
- which JSON snapshot files are used,
- how they are generated, updated and consumed,
- full field-level schemas for each JSON type.

JSON files are **not** the primary long-term storage (that is MariaDB).  
They are **lightweight snapshots** for:

- interoperability between modules,
- integration with external tools (LLM, manual editing),
- debugging and quick diagnostics.

---

## 2. Overview of the Data Flow

At a high level, the pipeline looks like this:

```text
Binance (candles, derivatives) ---> MariaDB (raw/history)
                                          |
                                          v
                             Analytics Engine (5 min)
                                          |
      +----------------------+------------+-------------------------+
      |                      |                                      |
      v                      v                                      v
btc_snapshot.json     btc_flow.json                        decision.json
      |                      |                                      |
      +----------+-----------+--------------------------------------+
                 |
                 v
            Execution Engine (1–3s loop)
```

External context (ETF flows, liquidation zones, sentiment) enters as JSON:

```text
Screens (Farside, Coinglass) + User + LLM
        |
        +--> btc_etp_flow.json
        +--> btc_liquidation_map.json
        +--> news_sentiment.json
                      |
                      v
                Analytics Engine
```

All cycles (Analytics, Decisions, Execution) log their results into MariaDB.

---

## 3. Snapshot Files: Overview

The system uses the following JSON files in `data/`:

1. **`btc_snapshot.json`**  
   Structural snapshot of the BTCUSDT market at a given time.

2. **`btc_flow.json`**  
   Aggregated “flow” context: derivatives, ETF, liqs, crowd, trap, warnings, risk.

3. **`btc_etp_flow.json`**  
   ETF flows history and summarized signal (manually updated via LLM + user).

4. **`btc_liquidation_map.json`**  
   Liquidation zones map (manually updated via LLM + user from screenshots).

5. **`news_sentiment.json`**  
   Manual sentiment input (news/social mood).

6. **`decision.json`**  
   Latest trading decision produced by the Decision Engine.

> **Note:**  
> All of these have **latest-only** semantics as JSON files, but their full history lives in MariaDB tables:
> `snapshots`, `flows`, `etp_flows`, `liquidation_zones_history`, `news_sentiment_history`, `decisions`, etc.

---

## 4. `btc_snapshot.json` – Market Snapshot

### 4.1 Purpose and Update Frequency

- Generated by **Analytics Engine** every **5 minutes**.
- Represents a compact view of:
  - price,
  - key candles,
  - market structure (HH/HL/LH/LL),
  - momentum per timeframe,
  - volatility regime,
  - trading session.

Used by:

- Decision Engine (main input).
- Dashboard.
- Backtesting module (via DB `snapshots` equivalent).

### 4.2 Example

```json
{
  "symbol": "BTCUSDT",
  "timestamp_iso": "2025-11-28T10:00:00Z",
  "timestamp_ms": 1764324000000,
  "price": 90850.0,

  "candles": {
    "tf_1m":  { "o": 90780, "h": 90900, "l": 90750, "c": 90850, "v": 123.4 },
    "tf_5m":  { "o": 90500, "h": 91000, "l": 90400, "c": 90850, "v": 654.3 },
    "tf_15m": { "o": 90000, "h": 91200, "l": 89800, "c": 90850, "v": 3210.7 },
    "tf_1h":  { "o": 89000, "h": 91500, "l": 88500, "c": 90850, "v": 12890.0 }
  },

  "market_structure": {
    "tf_5m":  "HH-HL",
    "tf_15m": "HH-HL",
    "tf_1h":  "LL-LH"
  },

  "momentum": {
    "tf_5m":  { "state": "impulse_up", "score": 0.78 },
    "tf_15m": { "state": "fading",     "score": 0.44 },
    "tf_1h":  { "state": "neutral",    "score": 0.52 }
  },

  "session": {
    "current": "EU",
    "time_utc": "10:00",
    "volatility_regime": "normal"
  }
}
```

### 4.3 Schema

- `symbol` (string): trading pair, e.g. `"BTCUSDT"`.
- `timestamp_iso` (string, ISO8601 UTC): moment of snapshot.
- `timestamp_ms` (integer): Unix timestamp in milliseconds.
- `price` (number): last or mid-market price at snapshot time.

#### `candles` (object, required)

Keys follow the pattern `tf_<tf_name>`:

- `tf_1m`, `tf_5m`, `tf_15m`, `tf_1h`, etc.

Each TF object:

- `o` (number): open.
- `h` (number): high.
- `l` (number): low.
- `c` (number): close.
- `v` (number): volume.

#### `market_structure` (object)

For each TF where structure is computed (at minimum 5m, 15m, 1h):

- value (string) takes one of:
  - `"HH-HL"` – bullish trend.
  - `"LL-LH"` – bearish trend.
  - `"range"` – sideways.
  - Other patterns as needed (e.g. `"transition"`, `"unclear"`).

#### `momentum` (object)

Per timeframe:

- `state` (string):
  - `"impulse_up"`,
  - `"impulse_down"`,
  - `"fading"`,
  - `"choppy"`,
  - `"neutral"`.
- `score` (number, 0–1): strength of momentum in current direction.

#### `session` (object)

- `current` (string): `"ASIA"`, `"EU"`, `"US"` (or a defined enum).
- `time_utc` (string): `"HH:MM"`.
- `volatility_regime` (string):
  - `"low"`,
  - `"normal"`,
  - `"high"`.

---

## 5. `btc_flow.json` – Aggregated Flow & Crowd Context

### 5.1 Purpose and Update Frequency

- Generated by **Analytics Engine** every **5 minutes**, immediately after `btc_snapshot`.
- Combines:

  - derivatives (`derivatives` block),
  - ETF flows (`etp_summary`),
  - liquidation map (`liquidation_zones`),
  - manual sentiment (`news_sentiment`),
  - crowd bias (`crowd`),
  - trap index (`trap_index`),
  - human-readable warnings (`warnings`),
  - risk state (`risk`).

Used by:

- Decision Engine.
- Dashboard.
- Backtesting (via DB `flows`).

### 5.2 Example

```json
{
  "symbol": "BTCUSDT",
  "timestamp_iso": "2025-11-28T10:00:00Z",

  "derivatives": {
    "oi": {
      "value": 123456789.0,
      "change_24h": 0.04
    },
    "funding": {
      "current": 0.012,
      "avg_24h": 0.009
    },
    "cvd": {
      "tf_1h": {
        "value": 12345.0,
        "direction": "up"
      },
      "tf_4h": {
        "value": -54321.0,
        "direction": "down"
      }
    }
  },

  "etp_summary": {
    "last_7d_total": -235000000.0,
    "last_3d_total": 45000000.0,
    "trend": "recovering",
    "signal": "bullish_reversal",
    "comment": "После серии оттоков появились 3 дня притоков"
  },

  "liquidation_zones": {
    "below_price": [
      { "price": 86000.0, "zone": [85500.0, 86500.0], "side": "short", "strength": 0.8 },
      { "price": 82000.0, "zone": [81500.0, 82500.0], "side": "short", "strength": 0.6 }
    ],
    "above_price": [
      { "price": 95000.0, "zone": [94500.0, 95500.0], "side": "long", "strength": 0.9 },
      { "price": 99000.0, "zone": [98500.0, 99500.0], "side": "long", "strength": 0.7 }
    ],
    "as_of": "2025-11-28T12:00:00Z"
  },

  "crowd": {
    "bias_score": 0.73,
    "bias_side": "long",
    "description": "толпа агрессивно лонгует через фьючи"
  },

  "trap_index": {
    "score": 0.81,
    "side": "long",
    "comment": "много лонгов загнали на хаях, есть топливо вниз"
  },

  "news_sentiment": {
    "as_of": "2025-11-28T10:00:00Z",
    "score": 1,
    "label": "bullish",
    "comment": "Позитивные новости по ETF и макро"
  },

  "warnings": [
    {
      "type": "extreme_funding",
      "severity": "high",
      "message": "слишком дорогие лонги, риск шорта-отката"
    },
    {
      "type": "liq_cluster_above",
      "severity": "medium",
      "message": "сильный кластер ликвидаций лонгов выше цены"
    }
  ],

  "risk": {
    "global_score": 0.62,
    "mode": "cautious_risk_on"
  }
}
```

### 5.3 Schema

- `symbol` (string): `"BTCUSDT"`.
- `timestamp_iso` (string, ISO8601 UTC).

#### `derivatives` (object)

- `oi` (object):
  - `value` (number): current open interest.
  - `change_24h` (number): relative change (e.g. 0.04 for +4%).
- `funding` (object):
  - `current` (number): current funding rate.
  - `avg_24h` (number): 24h average funding.
- `cvd` (object):
  - `tf_1h` / `tf_4h` / etc.:
    - `value` (number).
    - `direction` (string: `"up"`, `"down"`, `"flat"`).

Additional derivative metrics can be added as needed (basis, perps/spot premium, etc.).

#### `etp_summary` (object, summary from `btc_etp_flow.json`)

- `last_7d_total` (number): sum of ETF net flows over last 7 days (USD).
- `last_3d_total` (number): sum over last 3 days.
- `trend` (string): high-level description:
  - `"draining"`, `"accumulating"`, `"recovering"`, etc.
- `signal` (string): trading-lens interpretation:
  - `"bullish"`, `"bearish"`, `"bullish_reversal"`, `"bearish_exhaustion"`, etc.
- `comment` (string): human-friendly description used in analytics.

#### `liquidation_zones` (object, summary from `btc_liquidation_map.json`)

- `below_price` (array of objects): zones below current price.
- `above_price` (array of objects): zones above current price.
- `as_of` (string, ISO8601 UTC): time when liquidation map snapshot was taken.

Each zone:

- `price` (number): center price.
- `zone` (array of 2 numbers): `[min_price, max_price]`.
- `side` (string):
  - `"short"` for short liquidations below,
  - `"long"` for long liquidations above.
- `strength` (number, 0–1): normalized strength of the cluster.

#### `crowd` (object)

- `bias_score` (number, 0–1): how skewed the crowd is.
- `bias_side` (string): `"long"`, `"short"`, `"neutral"`.
- `description` (string): human-readable explanation.

#### `trap_index` (object)

- `score` (number, 0–1): how “trapped” the crowd is.
- `side` (string): `"long"` or `"short"` — which side is trapped.
- `comment` (string): textual description.

#### `news_sentiment` (object)

Same format as `news_sentiment.json` (see section 7), embedded for convenience.

#### `warnings` (array)

List of risk warnings for the current context. Each element:

- `type` (string, enum):
  - `"extreme_funding"`,
  - `"extreme_oi"`,
  - `"liq_cluster_above"`,
  - `"liq_cluster_below"`,
  - `"etf_strong_outflow"`,
  - `"etf_strong_inflow"`,
  - `"sentiment_extreme"` etc.
- `severity` (string): `"low"`, `"medium"`, `"high"`.
- `message` (string): short human-readable warning.

#### `risk` (object)

- `global_score` (number, 0–1): combined risk metric.
- `mode` (string):
  - `"risk_off"`,
  - `"neutral"`,
  - `"cautious_risk_on"`,
  - `"aggressive_risk_on"`.

---

## 6. `btc_etp_flow.json` – ETF Flows

### 6.1 Purpose and Update Process

- Updated **manually** by the user, with help from LLM, based on screenshots from Farside (or similar).
- Normalizes ETF flow data into a consistent structure.
- Provides:
  - historical net flows by day,
  - summarized totals (7d, 3d),
  - qualitative trend and signal.

### 6.2 Example

```json
{
  "symbol": "BTC",
  "history": [
    { "date": "2025-11-21", "net_flow_usd": -120000000.0 },
    { "date": "2025-11-22", "net_flow_usd": -80000000.0 },
    { "date": "2025-11-23", "net_flow_usd": -50000000.0 },
    { "date": "2025-11-24", "net_flow_usd": -20000000.0 },
    { "date": "2025-11-25", "net_flow_usd": 5000000.0 },
    { "date": "2025-11-26", "net_flow_usd": 15000000.0 },
    { "date": "2025-11-27", "net_flow_usd": 25000000.0 }
  ],
  "summary": {
    "last_7d_total": -235000000.0,
    "last_3d_total": 45000000.0,
    "trend": "recovering",
    "signal": "bullish_reversal",
    "comment": "После серии оттоков появились 3 дня притоков"
  },
  "as_of": "2025-11-28T00:00:00Z"
}
```

### 6.3 Schema

- `symbol` (string): `"BTC"` (underlying asset).
- `history` (array):
  - each element:
    - `date` (string, `YYYY-MM-DD`).
    - `net_flow_usd` (number): net flow for that day in **USD** (already converted from millions if needed).
- `summary` (object):
  - `last_7d_total` (number): sum of `net_flow_usd` over last 7 days.
  - `last_3d_total` (number): sum over last 3 days.
  - `trend` (string): descriptive tag.
  - `signal` (string): trading signal string used by Decision Engine.
  - `comment` (string): explanation.
- `as_of` (string, ISO8601 UTC): date/time of the last included day.

**Validation constraints:**

- `history` must be sorted by `date` ascending.
- No duplicate `date` entries.
- Values should be floats/integers; missing values not allowed.

---

## 7. `btc_liquidation_map.json` – Liquidation Zones

### 7.1 Purpose and Update Process

- Updated manually by the user with assistance from LLM based on screenshots of:
  - Hyperliquid / Coinglass liquidation heatmap.
- Captures **major liquidation clusters** above and below current price.

### 7.2 Example

```json
{
  "symbol": "BTC",
  "as_of": "2025-11-28T12:00:00Z",
  "current_price": 90850.0,
  "below_price": [
    {
      "price": 86000.0,
      "zone": [85500.0, 86500.0],
      "side": "short",
      "strength": 0.8,
      "comment": "крупный кластер шортов снизу"
    }
  ],
  "above_price": [
    {
      "price": 95000.0,
      "zone": [94500.0, 95500.0],
      "side": "long",
      "strength": 0.9,
      "comment": "главный магнит ликвидаций лонгов сверху"
    }
  ]
}
```

### 7.3 Schema

- `symbol` (string): `"BTC"`.
- `as_of` (string, ISO8601 UTC).
- `current_price` (number): current or approximate market price used to classify zones “above” and “below”.
- `below_price` (array of zone objects).
- `above_price` (array of zone objects).

Zone object:

- `price` (number): center of the cluster.
- `zone` (array, length 2, `[min, max]`): price range of the cluster.
- `side` (string):
  - `"short"`: primarily short liquidations expected below current price.
  - `"long"`: long liquidations above.
- `strength` (number, 0–1): normalized strength.
- `comment` (string, optional): textual note.

**Validation constraints:**

- `zone[0] <= price <= zone[1]`.
- `strength` ∈ [0, 1].
- `below_price` clusters typically have `zone` ranges below `current_price`, `above_price` above it (not strictly enforced but recommended).

---

## 8. `news_sentiment.json` – Manual Sentiment Input

### 8.1 Purpose and Update Process

- Updated via Dashboard form.
- Reflects **global news/social mood** relevant for BTC on short horizon.
- Allows human override of purely quantitative signals.

### 8.2 Example

```json
{
  "as_of": "2025-11-28T10:00:00Z",
  "score": 1,
  "label": "bullish",
  "comment": "Позитивные новости по ETF и макро"
}
```

### 8.3 Schema

- `as_of` (string, ISO8601 UTC): when sentiment was last updated.
- `score` (integer or small float, typical range -2…+2):
  - -2: strongly bearish,
  - -1: bearish,
  - 0: neutral,
  - +1: bullish,
  - +2: strongly bullish.
- `label` (string, derived from score):
  - `"bearish"`, `"neutral"`, `"bullish"` (or extended set).
- `comment` (string): free-form text.

**Validation constraints:**

- `score` consistent with `label` by simple mapping.
- `as_of` should not lag too far behind current time (dashboard may warn about stale sentiment).

---

## 9. `decision.json` – Trade Decision Snapshot

### 9.1 Purpose and Update Frequency

- Produced by **Decision Engine** every **5 minutes** as part of the Analytics Loop.
- Contains:

  - action (long/short/flat),
  - entry zone,
  - SL/TP,
  - size, leverage,
  - confidence,
  - risk checks and reasons.

- Consumed by:
  - Execution Engine (live mode).
  - Backtesting Engine (historical replay via DB).

### 9.2 Example

```json
{
  "symbol": "BTCUSDT",
  "timestamp_iso": "2025-11-28T10:05:00Z",

  "action": "long",
  "reason": "trend_up_multi_tf_with_etf_support_and_liq_below",

  "entry_zone": [90700.0, 90900.0],
  "sl": 89800.0,
  "tp1": 92200.0,
  "tp2": 93500.0,

  "risk_level": 3,
  "position_size_usdt": 1000.0,
  "leverage": 3,

  "confidence": 0.76,

  "risk_checks": {
    "daily_dd_ok": true,
    "weekly_dd_ok": true,
    "max_trades_per_day_ok": true,
    "session_ok": true,
    "no_major_news": false
  }
}
```

### 9.3 Schema

- `symbol` (string): `"BTCUSDT"`.
- `timestamp_iso` (string, ISO8601 UTC): decision time, aligned with snapshot/flow.
- `action` (string):
  - `"long"`, `"short"`, `"flat"`.
- `reason` (string):
  - compressed explanation string (used for logging and debugging).

#### Trade parameters

- `entry_zone` (array `[min, max]`, numbers):
  - For `action = "flat"` may be omitted or null.
  - Defines price band for initial entry orders.
- `sl` (number): stop-loss price.
- `tp1` (number, optional): first take-profit target.
- `tp2` (number, optional): second take-profit target.

#### Risk parameters

- `risk_level` (integer, 1–5 or another discrete scale):
  - 1: very conservative,
  - 3: normal,
  - 5: very aggressive (but may be restricted by overall risk mode).
- `position_size_usdt` (number): notional position size in USDT.
- `leverage` (number): target leverage (subject to caps based on mode).

#### Confidence

- `confidence` (number, 0–1): how strong and coherent the setup is based on all inputs.

#### `risk_checks` (object)

- `daily_dd_ok` (bool): is daily drawdown within allowed limit?
- `weekly_dd_ok` (bool): is weekly drawdown within allowed limit?
- `max_trades_per_day_ok` (bool): is number of trades today acceptable?
- `session_ok` (bool): does the session allow new trades?
- `no_major_news` (bool): true if there is no major external news event.

> If any of these checks fail, Decision Engine should normally return `"action": "flat"` and/or mark the decision as low-confidence.

---

## 10. History in MariaDB vs JSON Snapshots

Although this document focuses on JSON, the **true history** of all snapshots is stored in MariaDB.

Typical mapping:

- `btc_snapshot.json` → `snapshots` table.
- `btc_flow.json` → `flows` table.
- `btc_etp_flow.json.history` → `etp_flows` table.
- `btc_liquidation_map.json` → `liquidation_zones_history` (multiple rows per snapshot).
- `news_sentiment.json` → `news_sentiment_history`.
- `decision.json` → `decisions`.
- Trades related to decisions → `orders`, `trades`, `equity_curve`.

JSON snapshots are regenerated **at each 5-minute cycle**, but DB tables keep all past versions for:

- performance analysis,
- risk analysis,
- backtesting and research.

See `DATABASE_SCHEMA.md` for full schema definitions.

---

## 11. Validation and Error Handling

To keep the pipeline robust, the system should enforce basic validation on all JSON inputs:

1. **Strict required fields**
   - If a required field is missing or type is wrong → reject update and log an ERROR.
2. **Range checks**
   - Scores in [0, 1] or [-2, 2].
   - Prices > 0.
   - Arrays of correct length for zones, entry_zone, etc.
3. **Date/time sanity**
   - `as_of` and `timestamp_iso` must be valid ISO8601.
   - Should not lag too far behind current time (configurable).
4. **Consistency checks**
   - `zone[0] <= zone[1]`.
   - `entry_zone[0] <= entry_zone[1]`.
   - In ETF history, dates are unique and ascending.

Errors in **manual JSONs** (ETF, liqs, sentiment) should:

- be logged;
- be visible in dashboard;
- not crash Analytics Engine: it may skip that component for this cycle and add a `warning`.

---

## 12. Backtesting Integration

Backtesting Engine uses the **same logical structure** as live pipeline:

- In backtest mode it reconstructs:
  - snapshots,
  - flows,
  - decisions
from historical data stored in MariaDB, not from JSON files.

However, the JSON schemas defined here are mirrored in DB columns:

- columns often store small JSON blobs in text/JSON fields (e.g. `market_structure_json`, `etp_summary_json`),
- or decomposed into strongly typed columns (e.g. price, OI, funding).

This guarantees that:

- backtest and live paths are consistent,
- Decision Engine always sees identical object structures, regardless of source.

See `BACKTESTING.md` for details.

---

## 13. Summary

The data pipeline of AI Trading Showdown Bot is built around:

- **Raw/historical storage in MariaDB.**
- **Compact JSON snapshots** for the most recent state of:
  - market structure (`btc_snapshot.json`),
  - flows and risk (`btc_flow.json`),
  - external context (ETF, liquidations, sentiment),
  - trading decisions (`decision.json`).

These JSON files are:

- generated deterministically by Analytics and Decision Engine (every 5 minutes),
- partially edited or provided by a human+LLM workflow (ETF, liqs, sentiment),
- consumed by Execution Engine and Dashboard,
- mirrored and archived in DB for deep analysis and backtesting.

Together with `ARCHITECTURE.md`, `DECISION_ENGINE.md`, `EXECUTION_ENGINE.md`, `RISK_MANAGER.md` and `DATABASE_SCHEMA.md`, this document defines the **contract** between all modules of the system.
